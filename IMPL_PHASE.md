## 🛠 実装ロードマップ：スマートホーム可視化基盤

### 【フェーズ 1】 蓄積層の確立（インフラ編）

Exporterが吐き出すデータを「記憶」させるフェーズです。

1. **VictoriaMetricsのデプロイ:**
* `StatefulSet` として VictoriaMetrics (VM) をデプロイし、データを永続化。


2. **スクレイプ（収集）設定:**
* VMがExporterのPort 8000からデータを定期的に吸い上げる設定。
* （Prometheus Operatorを使っているなら `ServiceMonitor` を作成）


3. **Grafanaによる暫定可視化:**
* VMをデータソースとして、グラフをGrafana上に構築。実機が届く前にモックデータが蓄積される様子を確認。



---

### 【フェーズ 2】 知能の実装（BFF / FastAPI編）

単なる「数値」を「お金の情報」に変換するロジックを作ります。

1. **SQLiteによる単価履歴管理:**
* 「2026年1月：27円/kWh」「2026年2月：30円/kWh」といった期間ごとの単価を保存。


2. **コスト計算ロジックの構築:**
* VMから取得した消費電力（W）を積分し、単価履歴と掛け合わせるアルゴリズム。
* 期待される計算ロジック ():




3. **APIエンドポイントの公開:**
* Frontendが必要とする「今日のコスト」「今月の予測値」などを返すAPIを実装。



---

### 【フェーズ 3】 インターフェースの構築（Frontend / Next.js編）

Aobaさんが毎日眺めたくなるような「顔」を作るフェーズです。

1. **ダッシュボードUIの作成:**
* 各部屋、各棚ごとの電力・コストをドリルダウン表示。


2. **リアルタイム連携:**
* SWRやReact Queryを使い、BFFから最新のコスト情報を取得。


3. **設定画面の追加:**
* デバイスの追加や、電気代の単価変更をブラウザから行えるようにする。



---

### 【フェーズ 4】 発展と自動化（エンジニアのこだわり編）

Aobaさんの興味分野（AI, Security, GitOps）を詰め込むフェーズです。

1. **予測モデルの導入（AI/ML）:**
* 修士論文の知見（グラフ生成や時系列予測）を活かし、過去のデータから「今月の請求額」を予測する機能をBFFに搭載。


2. **GitOps (ArgoCD/Flux) の導入:**
* `k8s/` 配下のマニフェストをGitHubと同期し、リポジトリを更新するだけでデプロイが完了する環境へ。


3. **アラート通知:**
* 「サーバーの電力が異常に高い」「API制限が近い」場合にDiscordやSlackへ通知。



---

## 📈 現在の立ち位置と次のアクション

**✅ 【フェーズ 1】完了！** - VictoriaMetricsによる蓄積層の確立

- ✅ **VictoriaMetricsの基盤**: StatefulSet、ストレージ、Scrape設定が完了
- ✅ **階層化ドキュメント**: 運用・トラブルシューティングガイド整備
- ✅ **Exporter連携**: SwitchBotから時系列データが蓄積される仕組みが稼働準備完了

**現在のデータフロー:**
```
[SwitchBot API] → [Exporter] → [VictoriaMetrics] → (時系列データ永続化完了)
```

**🚀 次のアクション候補:**

**Would you like to ...**

1. **📡 今すぐデプロイ実行**: VictoriaMetricsを実際のK8sクラスターに起動して、データ蓄積開始
2. **⚡ フェーズ2開始**: BFF（FastAPI）でSQLiteベースのコスト計算ロジック実装
3. **🔍 実装レビュー**: 作成されたマニフェストの最終確認・調整