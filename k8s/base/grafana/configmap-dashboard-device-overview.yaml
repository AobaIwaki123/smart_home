apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-device-overview
  labels:
    app: grafana
    component: visualization
data:
  device-overview.json: |
    {
      "uid": "smart-home-device-overview",
      "title": "Smart Home — Device Overview",
      "tags": ["smart-home"],
      "timezone": "browser",
      "refresh": "15s",
      "time": { "from": "now-1h", "to": "now" },
      "templating": {
        "list": [
          {
            "name": "job",
            "label": "Job",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "victoriametrics" },
            "query": "label_values(switchbot_device_up, job)",
            "current": {},
            "multi": true,
            "includeAll": true,
            "allValue": ".+",
            "refresh": 2,
            "sort": 1
          }
        ]
      },
      "panels": [
        {
          "id": 1, "type": "stat", "title": "Total Devices",
          "gridPos": { "x": 0, "y": 0, "w": 4, "h": 4 },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "none", "graphMode": "none", "textMode": "auto" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "steps": [{ "color": "text", "value": null }] } }, "overrides": [] },
          "targets": [{ "expr": "count(switchbot_device_up{job=~\"$job\"})", "instant": true, "refId": "A", "legendFormat": "" }],
            "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 2, "type": "stat", "title": "UP",
          "gridPos": { "x": 4, "y": 0, "w": 4, "h": 4 },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none", "textMode": "auto" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] } }, "overrides": [] },
          "targets": [{ "expr": "count(switchbot_device_up{job=~\"$job\"} == 1) or vector(0)", "instant": true, "refId": "A", "legendFormat": "" }],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 3, "type": "stat", "title": "DOWN",
          "gridPos": { "x": 8, "y": 0, "w": 4, "h": 4 },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none", "textMode": "auto" },
          "fieldConfig": { "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] } }, "overrides": [] },
          "targets": [{ "expr": "count(switchbot_device_up{job=~\"$job\"} == 0) or vector(0)", "instant": true, "refId": "A", "legendFormat": "" }],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 4, "type": "stat", "title": "Total Power",
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 4 },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "none", "graphMode": "area", "textMode": "auto" },
          "fieldConfig": {
            "defaults": {
              "unit": "watt",
              "color": { "mode": "thresholds" },
              "thresholds": { "steps": [{ "color": "blue", "value": null }] }
            },
            "overrides": []
          },
          "targets": [{ "expr": "sum(switchbot_power_watts{job=~\"$job\"})", "instant": false, "refId": "A", "legendFormat": "" }],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 10, "type": "table", "title": "Device Status",
          "gridPos": { "x": 0, "y": 4, "w": 24, "h": 9 },
          "options": {
            "frameIndex": 0,
            "showHeader": true,
            "sortBy": [{ "displayName": "device_id", "desc": false }]
          },
          "fieldConfig": {
            "defaults": { "custom": { "align": "auto", "filterable": true } },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "state" },
                "properties": [
                  {
                    "id": "mappings",
                    "value": [
                      { "type": "value", "options": { "1": { "text": "UP ✓", "color": "green", "index": 0 } } },
                      { "type": "value", "options": { "0": { "text": "DOWN ✗", "color": "red", "index": 1 } } }
                    ]
                  },
                  { "id": "custom.displayMode", "value": "color-background" },
                  { "id": "custom.width", "value": 120 }
                ]
              },
              {
                "matcher": { "id": "byName", "options": "Power (W)" },
                "properties": [
                  { "id": "unit", "value": "watt" },
                  { "id": "decimals", "value": 1 },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "yellow", "value": 200 },
                        { "color": "red", "value": 450 }
                      ]
                    }
                  },
                  { "id": "custom.displayMode", "value": "gradient-gauge" },
                  { "id": "custom.width", "value": 200 }
                ]
              },
              { "matcher": { "id": "byName", "options": "Time" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "job" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "instance" }, "properties": [{ "id": "custom.hidden", "value": true }] },
              { "matcher": { "id": "byName", "options": "parent_id" }, "properties": [{ "id": "custom.hidden", "value": true }] }
            ]
          },
          "transformations": [
            { "id": "labelsToFields", "options": { "mode": "columns" } },
            { "id": "merge", "options": {} },
            {
              "id": "organize",
              "options": {
                "renameByName": {
                  "device_name": "name",
                  "Value #A": "Power (W)",
                  "Value #B": "state"
                },
                "indexByName": {
                  "device_id": 0,
                  "device_name": 1,
                  "room": 2,
                  "shelf": 3,
                  "device": 4,
                  "Value #B": 5,
                  "Value #A": 6,
                  "parent_id": 7,
                  "job": 8,
                  "instance": 9,
                  "Time": 10
                }
              }
            }
          ],
          "targets": [
            {
              "expr": "switchbot_power_watts{job=~\"$job\"}",
              "instant": true,
              "refId": "A",
              "legendFormat": "{{device_id}}"
            },
            {
              "expr": "switchbot_device_up{job=~\"$job\"}",
              "instant": true,
              "refId": "B",
              "legendFormat": "{{device_id}}"
            }
          ],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 20, "type": "timeseries", "title": "Power (W) per Device",
          "gridPos": { "x": 0, "y": 13, "w": 24, "h": 9 },
          "options": {
            "tooltip": { "mode": "multi", "sort": "desc" },
            "legend": { "displayMode": "table", "placement": "bottom", "calcs": ["last", "max", "mean"] }
          },
          "fieldConfig": {
            "defaults": {
              "unit": "watt",
              "custom": { "lineWidth": 2, "fillOpacity": 10 }
            },
            "overrides": []
          },
          "targets": [{
            "expr": "switchbot_power_watts{job=~\"$job\"}",
            "refId": "A",
            "legendFormat": "{{device_name}} ({{room}})"
          }],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        },
        {
          "id": 21, "type": "timeseries", "title": "Device UP Status",
          "gridPos": { "x": 0, "y": 22, "w": 24, "h": 5 },
          "options": {
            "tooltip": { "mode": "multi" },
            "legend": { "displayMode": "list", "placement": "bottom" }
          },
          "fieldConfig": {
            "defaults": {
              "min": 0, "max": 1,
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN", "color": "red" } } },
                { "type": "value", "options": { "1": { "text": "UP", "color": "green" } } }
              ],
              "custom": { "lineWidth": 2, "fillOpacity": 30, "drawStyle": "line", "lineInterpolation": "stepAfter" },
              "thresholds": {
                "mode": "absolute",
                "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }]
              },
              "color": { "mode": "thresholds" }
            },
            "overrides": []
          },
          "targets": [{
            "expr": "switchbot_device_up{job=~\"$job\"}",
            "refId": "A",
            "legendFormat": "{{device_id}}"
          }],
          "datasource": { "type": "prometheus", "uid": "victoriametrics" }
        }
      ],
      "schemaVersion": 39
    }
