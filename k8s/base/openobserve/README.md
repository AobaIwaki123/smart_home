# OpenObserve (O2) - å¯è¦³æ¸¬æ€§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 

ã‚¹ãƒãƒ¼ãƒˆãƒ›ãƒ¼ãƒ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ã€Œå¯è¦–åŒ–ãƒ»åˆ†æå±¤ã€ã‚’æ‹…ã†OpenObserveã®Kubernetesãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã€‚

## ğŸ¯ **æ¦‚è¦**

OpenObserveã¯ã€ãƒ­ã‚°ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’çµ±åˆçš„ã«ç®¡ç†ãƒ»å¯è¦–åŒ–ã™ã‚‹è¶…è»½é‡ãªå¯è¦³æ¸¬æ€§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
å¾“æ¥ã®ãƒªãƒƒãƒãªæ§‹æˆï¼ˆGrafana + Loki + Tempoãªã©ï¼‰ã¨æ¯”è¼ƒã—ã¦åœ§å€’çš„ã«å°‘ãªã„ãƒªã‚½ãƒ¼ã‚¹ã§å‹•ä½œã—ã€Rustè£½ã«ã‚ˆã‚‹é«˜é€Ÿãªå‡¦ç†ãŒç‰¹å¾´ã§ã™ã€‚

### **ã‚·ã‚¹ãƒ†ãƒ ã®å½¹å‰²**
*   **ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–åŒ–**: é›»åŠ›æ¶ˆè²»ã‚„ã‚³ã‚¹ãƒˆã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆå¾“æ¥ã®Grafanaã®å½¹å‰²ã‚’ä»£æ›¿ï¼‰
*   **ğŸ—„ï¸ ãƒ­ã‚°ç®¡ç†**: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ç¾¤ï¼ˆBFF, Exporterï¼‰ã‹ã‚‰ã®ãƒ­ã‚°é›†ç´„
*   **ğŸ”— çµ±åˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã®å½¹å‰²ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¨ã—ã¦ã®å½¹å‰²ã‚’å…¼å‹™

## ğŸ¤ **ä»–ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®æ¥ç¶š**

*   **MinIO (S3äº’æ›ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)**:
    *   OpenObserveã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å…ˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
    *   ãƒ­ã‚°ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®é•·æœŸä¿å­˜ã‚’è¡Œã„ã¾ã™ã€‚
*   **VictoriaMetrics**:
    *   ãƒ‡ãƒ¼ã‚¿ã®ç›¸äº’é‹ç”¨ã‚„ã€PromQLäº’æ›ã®ã‚¯ã‚¨ãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é€šã˜ã¦é€£æºã—ã¾ã™ã€‚

## âš™ï¸ **ç’°å¢ƒå¤‰æ•°ãƒ»è¨­å®š**

OpenObserveã®å‹•ä½œã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã¯ã€Deploymentå®šç¾©ãŠã‚ˆã³Kubernetesã®Secretã‹ã‚‰æ³¨å…¥ã•ã‚Œã¾ã™ã€‚
æ©Ÿå¯†æƒ…å ±ã¯ `k8s/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã€`make k8s-secret-generate` ã‚³ãƒãƒ³ãƒ‰ã§Secretã‚’ç”Ÿæˆã—ã¾ã™ã€‚

### **èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š**

| ç’°å¢ƒå¤‰æ•°å              | èª¬æ˜                         | æ³¨å…¥å…ƒ                                              |
| ----------------------- | ---------------------------- | --------------------------------------------------- |
| `ZO_ROOT_USER_EMAIL`    | rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | Secret: `openobserve-credentials` (key: `email`)    |
| `ZO_ROOT_USER_PASSWORD` | rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰     | Secret: `openobserve-credentials` (key: `password`) |

### **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š (MinIOé€£æº)**

OpenObserveã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦MinIOã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€MinIOã®æ¥ç¶šæƒ…å ±ã‚‚ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚

| ç’°å¢ƒå¤‰æ•°å                | è¨­å®šå€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | èª¬æ˜                                             |
| ------------------------- | -------------------- | ------------------------------------------------ |
| `ZO_S3_PROVIDER`          | `s3`                 | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ—ãƒ­ãƒã‚¤ãƒ€æŒ‡å®š                         |
| `ZO_S3_SERVER_URL`        | `http://minio:9000`  | MinIOã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL                         |
| `ZO_S3_REGION_NAME`       | `us-east-1`          | S3ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åï¼ˆMinIOäº’æ›ç”¨ï¼‰                    |
| `ZO_S3_BUCKET_NAME`       | `openobserve`        | ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãƒã‚±ãƒƒãƒˆå                       |
| `ZO_S3_ACCESS_KEY_ID`     | (from Secret)        | MinIOã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ï¼ˆ`minio-credentials`ã‚ˆã‚Šï¼‰     |
| `ZO_S3_SECRET_ACCESS_KEY` | (from Secret)        | MinIOã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ï¼ˆ`minio-credentials`ã‚ˆã‚Šï¼‰ |

### **ã‚·ã‚¹ãƒ†ãƒ è¨­å®š**

| ç’°å¢ƒå¤‰æ•°å                 | è¨­å®šå€¤ | èª¬æ˜                                       |
| -------------------------- | ------ | ------------------------------------------ |
| `ZO_MEMORY_CACHE_MAX_SIZE` | `256`  | ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€å¤§ã‚µã‚¤ã‚º (MB)      |
| `ZO_NODE_ROLE`             | `all`  | ãƒãƒ¼ãƒ‰ã®å½¹å‰²ï¼ˆå˜ä¸€ãƒãƒ¼ãƒ‰æ§‹æˆã®ãŸã‚ `all`ï¼‰ |

### **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (k8s/.env)**

ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ä»¥ä¸‹ã®å¤‰æ•°ã‚’ `k8s/.env` ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# OpenObserve
ZO_ROOT_USER_EMAIL=admin@example.com      # -> ZO_ROOT_USER_EMAIL
ZO_ROOT_USER_PASSWORD=ComplexPassword123! # -> ZO_ROOT_USER_PASSWORD
```

## ğŸš€ **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ & å‹•ä½œç¢ºèª**

OpenObserveã¯ `overlays/production` ã®ä¸€éƒ¨ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ï¼ˆèªè¨¼æƒ…å ±SecretãŒOverlayå±¤ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰ã€‚
å˜ä½“ã§ã®é©ç”¨ã§ã¯ãªãã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚

### **ãƒ‡ãƒ—ãƒ­ã‚¤**

```bash
# å…¨ä½“ï¼ˆProductoinç’°å¢ƒï¼‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤
make k8s-deploy-production

# ã¾ãŸã¯æ‰‹å‹•ã§å®Ÿè¡Œ:
# make k8s-secret-generate
# kubectl apply -k k8s/overlays/production
```

### **å‹•ä½œç¢ºèª**

#### WEB UI ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

> âš ï¸ `namePrefix: prod-` ãŒä»˜ããŸã‚ã€ã‚µãƒ¼ãƒ“ã‚¹åã¯ `prod-openobserve` ã§ã™ã€‚

```bash
# ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã®é–‹å§‹
kubectl port-forward -n smart-home svc/prod-openobserve 5080:5080
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:5080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚  
åˆå›ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã¯ Kubernetes ã® Secret (`prod-openobserve-credentials`) ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¢ºèªæ–¹æ³•

vmagent ãŒ OpenObserve ã« Prometheus Remote Write ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

**1. ãƒ­ã‚°ã§ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚’ç¢ºèªã™ã‚‹**

```bash
kubectl logs -n smart-home deployment/prod-vmagent --tail=20
kubectl logs -n smart-home deployment/prod-openobserve --tail=20 | grep "v1/write"
# â†’ "200" ãŒè¿”ã£ã¦ã„ã‚Œã°æ­£å¸¸ã«ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ã¦ã„ã¾ã™
# â†’ "401" ãŒç¶šãå ´åˆã¯ basicauth ã®ä¿®æ­£ãŒå¿…è¦ã§ã™ï¼ˆä¸‹è¨˜ã€Œãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€å‚ç…§ï¼‰
```

**2. OpenObserve UI ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã™ã‚‹**

1. `http://localhost:5080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® **Metrics** ã‚’é¸æŠ
3. Stream ã« `default` ã‚’é¸æŠã™ã‚‹ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. SwitchBot ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¾‹:
   - `switchbot_power_watts` â€” ãƒ‡ãƒã‚¤ã‚¹ã®æ¶ˆè²»é›»åŠ› (W)
   - `switchbot_voltage_volts` â€” é›»åœ§ (V)
   - `switchbot_device_up` â€” ãƒ‡ãƒã‚¤ã‚¹ç–é€šçŠ¶æ…‹ (1=æ­£å¸¸ / 0=ç•°å¸¸)
   - `api_rate_limit_remaining` â€” SwitchBot API æ®‹ã‚Šã‚³ãƒ¼ãƒ«æ•°

**3. PromQL ã§ã‚¯ã‚¨ãƒªã™ã‚‹**

å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® **Metrics** â†’ **Query** ã‚¿ãƒ–ã§ PromQL ãŒä½¿ç”¨ã§ãã¾ã™ã€‚

```promql
# ç›´è¿‘ã®æ¶ˆè²»é›»åŠ›
switchbot_power_watts

# ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®æ¶ˆè²»é›»åŠ›æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
rate(switchbot_power_watts[5m])

# API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®æ®‹ã‚Šå›æ•°
api_rate_limit_remaining
```

---

### **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**

#### vmagent â†’ OpenObserve ã¸ã®æ›¸ãè¾¼ã¿ãŒ 401 ã«ãªã‚‹

OpenObserve ã¸ã® Remote Write ã¯ Basic èªè¨¼ãŒå¿…è¦ã§ã™ã€‚  
vmagent ã¯ Secret `prod-openobserve-credentials` ã® `basicauth` ã‚­ãƒ¼ã‚’ `Authorization: Basic <å€¤>` ã¨ã—ã¦é€ä¿¡ã—ã¾ã™ã€‚

**`basicauth` ã®æ­£ã—ã„å€¤**:

Kubernetes ã® `data` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ ¼ç´å€¤ã‚’ base64 ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ Pod ã«æ¸¡ã—ã¾ã™ã€‚  
ãã®ãŸã‚ `basicauth` ã«ã¯ **`base64(base64(email:password))`** ã‚’æ ¼ç´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# æ­£ã—ã„ basicauth å€¤ã®ç”Ÿæˆæ–¹æ³•ï¼ˆ.env ã®å€¤ã‚’ä½¿ç”¨ï¼‰
source .env
printf '%s:%s' "$ZO_ROOT_USER_EMAIL" "$ZO_ROOT_USER_PASSWORD" | base64 | tr -d '\n' | base64
```

Secret ç”Ÿæˆã¯ `make k8s-secret-generate` ã‚’ä½¿ãˆã°è‡ªå‹•çš„ã«æ­£ã—ã„å€¤ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
