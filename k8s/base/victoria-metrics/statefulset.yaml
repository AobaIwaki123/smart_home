apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: victoria-metrics
  labels:
    app: victoria-metrics
    component: database
spec:
  serviceName: victoria-metrics
  replicas: 1
  selector:
    matchLabels:
      app: victoria-metrics
      component: database
  template:
    metadata:
      labels:
        app: victoria-metrics
        component: database
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000

      containers:
        - name: victoria-metrics
          # VictoriaMetricsの最新LTS版を使用
          image: victoriametrics/victoria-metrics:1.136.0
          imagePullPolicy: IfNotPresent

          args:
            # データ保存先の指定
            - -storageDataPath=/victoria-metrics-data
            # HTTP APIのリッスンアドレス
            - -httpListenAddr=0.0.0.0:8428
            # データ保持期間の設定（1年間）
            - -retentionPeriod=12
            # メモリ効率の最適化（おうちインフラ向け）
            - -memory.allowedPercent=50
            # VictoriaMetricsの独自機能を有効化
            - -search.latencyOffset=15s
            # ログレベル
            - -loggerLevel=INFO

          ports:
            - name: http
              containerPort: 8428
              protocol: TCP

          # ヘルスチェック設定
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          # リソース制限（Aobaさんのインフラに合わせた控えめな設定）
          resources:
            limits:
              cpu: "1"
              memory: "2Gi"
            requests:
              cpu: "100m"
              memory: "512Mi"

          # ボリュームマウント
          volumeMounts:
            - name: storage
              mountPath: /victoria-metrics-data
              subPath: data

          # 環境変数（必要に応じて）
          env:
            - name: GOMAXPROCS
              value: "1" # CPUコア数に合わせて調整

      # 永続化設定
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: victoria-metrics-storage

      # ポッドのアフィニティとトポロジー設定（高可用性のため）
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - victoria-metrics
                topologyKey: kubernetes.io/hostname

      # 再起動戦略
      restartPolicy: Always
      terminationGracePeriodSeconds: 60
