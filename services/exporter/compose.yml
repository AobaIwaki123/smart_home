services:
  switchbot-exporter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: switchbot-exporter
    ports:
      - "8000:8000"
    environment:
      # 環境変数の設定（本番では外部ファイルから読み込み）
      - SWITCHBOT_TOKEN=${SWITCHBOT_TOKEN:-your_token_here}
      - SWITCHBOT_SECRET=${SWITCHBOT_SECRET:-your_secret_here}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - METRICS_PORT=8000
      - COLLECTION_INTERVAL=${COLLECTION_INTERVAL:-60}
      # デバイス設定ファイルのパス
      - DEVICE_CONFIG_PATH=${DEVICE_CONFIG_PATH:-/app/devices.json}
    restart: unless-stopped

    # ヘルスチェック（メトリクスエンドポイントの生存確認）
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # リソース制限（メモリリーク等の予防）
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 64M
          cpus: "0.1"

  # Prometheus（オプション：メトリクス可視化用）
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-dev
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--web.enable-lifecycle"

networks:
  default:
    driver: bridge
